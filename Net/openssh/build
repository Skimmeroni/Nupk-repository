#!/bin/sh -e

PRETTY_NAME=openssh
MAJOR=9
MINOR=7
PATCH=p1
VERSION=9.7p1

mkdir temporary-builddir
DESTDIR="$PWD/temporary-builddir"

curl --location --remote-name --skip-existing https://ftp.openbsd.org/pub/OpenBSD/OpenSSH/portable/openssh-$VERSION.tar.gz

gzip -cd openssh-$VERSION.tar.gz | tar -x
cd openssh-$VERSION

./configure \
	--prefix=/usr \
	--datadir=/usr/share/openssh \
	--sysconfdir=/etc/ssh \
	--sbindir=/usr/bin \
	--libexecdir=/usr/lib/openssh \
	--without-selinux \
	--with-privsep-user=nobody \
	--with-mantype=doc \
	--without-rpath \
	--enable-strip \
	--with-ssl-engine \
	--with-pid-dir=/run \
	--disable-wtmp \
	--disable-utmp \
	--disable-security-key

make
make DESTDIR=$DESTDIR install

install -Dm755 ../sshd.run "$DESTDIR/etc/sv/sshd/run" 
ln -sf /run/runit/supervise.sshd "$DESTDIR/etc/sv/sshd/supervise"

doas chown -R root:root $DESTDIR
doas sh -c "tar -zcC $DESTDIR . | gzip > ../openssh@$VERSION.tar.gz"
